---
title: "Sampling Aware Ancestral State Inference"
author: "Yexuan Song"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
  pdf_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{Sampling Aware Ancestral State Inference}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
 knitr::opts_chunk$set(
   collapse = TRUE,
   comment = "#>",
   fig.width = 7,
   fig.height = 5
 )
```
```{r setup}
library(saasi)
library(diversitree)
library(tidytree)
library(ape)
library(phytools)
library(readr)
```

# Introduction

<!-- badges: start -->
<!-- badges: end -->

This vignette demonstrates how to use the `saasi` package for ancestral state reconstruction.

Saasi (Sampling-Aware Ancestral State Inference) is an ancestral state reconstruction method that accounts for variation in sampling rates among locations or traits. Unlike traditional methods that assume uniform sampling, saasi explicitly models heterogeneous sampling rates, leading to more accurate ancestral state estimates in unevenly sampled phylogenies.

NOTE: THIS DOCUMENT IS SUBJECT TO CHANGE (FUNCTION NAMES, ARGUMENTS ETC).

## Installation

You can install the development version of saasi from [GitHub](https://github.com/) with:
```r
# install.packages("remotes")
remotes::install_github("MAGPIE-SFU/saasi")
```

# Overview

The `saasi` function requires three main inputs:

1. **A phylogenetic tree** (class `phylo`) that is:
   - Rooted and binary
   - Has branch lengths in units of time (all positive)
   - Contains tip states (`tree$tip.state`) with no missing values
   
   Use `check_tree_compatibility()` to verify compatibility and `prepare_tree_for_saasi()` to prepare your tree.

2. **Birth-death-sampling parameters** (class `data.frame`):
   - Speciation rate 
   - Extinction/removal rate 
   - Sampling rate 
   
   Use `estimate_bds_parameters()` to estimate speciation and sampling rates. Users should specify the extinction rate based on domain knowledge.


3. **Transition rate matrix Q** (class `matrix`):
   - Rates of transition between states
   
   Use `estimate_transition_rates()` to estimate transition rates.

The output is a data frame containing the probability of each state for each internal node of the phylogenetic tree.

## Example: Ebola 2013-2016 West African Ebola Epidemic

### Read tree and load metadata

For this example, we use data from Nextstrain:
https://nextstrain.org/ebola/ebov-2013?c=country
```{r Nextstrain Ebola}
tree <- ape::read.tree(system.file("extdata", "nextstrain_ebola_ebov-2013_timetree.nwk", package = "saasi"))
metadata <- readr::read_tsv(system.file("extdata", "nextstrain_ebola_ebov-2013_metadata.tsv", package = "saasi"))
```

First, create a data frame containing strains and states. The first column of the data frame should match `tree$tip.label`, and the second column should contain the state of interest. Users can skip this step if `tree$tip.state` already exists.
```{r Tip.state}
tip_data <- data.frame(
  tip_label = metadata$strain,
  state = metadata$country
)
```

### Modify the tree to be compatible with saasi

Users can apply the function `prepare_tree_for_saasi()` to make the tree compatible with saasi. To check if the tree is compatible, use the function `check_tree_compatibility()`.
```{r Prepare tree}
ebola_tree <- prepare_tree_for_saasi(tree, tip_data)
```

### Estimating transition rates

Users can estimate the transition rate matrix Q using the function `estimate_transition_rates()`.
Users can specify the model for the transition rate matrix: 1. Equal rate `ER`,
2. Symmetric rate `SYM`, 3. All rates different `ARD`, and Custom `custom_q`.
```{r Estimate transition rates}
Q <- estimate_transition_rates(ebola_tree, method = 'simmap', model = 'SYM')
```

### Estimating speciation and sampling rates

Users can estimate speciation and sampling rates using the function `estimate_bds_parameters()`. Users should have some knowledge about the expected removal rate (1/mu) for the disease of interest, as saasi requires the extinction rate mu to be known. To obtain better estimates for the overall speciation and sampling rates, users should have knowledge about the maximum and minimum R0, as well as the upper and lower bounds for the total removal rate (1/(mu+psi)).

For Ebola, we assume the total infectious period (1/(mu+psi)) is between 20 and 40 days. Converting to years, the total removal rate (mu + psi) is between 9.125 (365/40) and 18.25 (365/20). If we assume mu = 5, this gives us bounds for the overall sampling rate psi between 4.125 and 13.25. In this example, we assume R0 is between 1.5 and 3.
```{r Estimate speciation and sampling rates}
rates <- estimate_bds_parameters(
    ebola_tree,
    mu = 5, 
    r0_max = 3, 
    r0_min = 1.5,
    psi_max = 15,
    infectious_period_min = 20/365, # convert days to years
    infectious_period_max = 40/365, # convert days to years
    n_starts = 100)
```

### Setting up input parameters
```{r Setting up input parameters}
pars1 <- create_params_template(colnames(Q), lambda = rates$lambda, mu = rates$mu, psi = rates$psi)
```

### Run saasi analysis
```{r Run saasi analysis}
saasi_ebola <- saasi(ebola_tree, pars1, Q)
```

### Plot and save the result

Users can use the built-in function `plot_saasi()` to visualize results. Set `save_file = NULL` to display without saving.
```{r Plot the result}
p1 <- plot_saasi(ebola_tree, saasi_ebola, save_file = "ebola_equal_psi.png")
```

### Run saasi with a different set of parameters

Users can specify different parameters for different locations. For example, if we assume that Liberia samples at half the rate of other countries:
```{r Run saasi with a different set of parameters}
pars2 <- create_params_template(colnames(Q), lambda = rates$lambda, mu = rates$mu, psi = c(rates$psi, rates$psi/2, rates$psi))

saasi_ebola2 <- saasi(ebola_tree, pars2, Q)

p2 <- plot_saasi(ebola_tree, saasi_ebola2, save_file = "ebola_unequal_psi.png")
```

### Interpreting results

The `saasi()` function returns a data frame with probability distributions over states for each internal node. Higher probabilities indicate greater confidence in that ancestral state. When comparing equal versus unequal sampling rates, you may notice differences in ancestral state probabilities, particularly for nodes ancestral to under-sampled locations like Liberia.